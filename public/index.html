<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>TikTok Live Chat (with Voice)</title>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; text-align: center; }
        #chat { max-width:600px; margin:20px auto; overflow-y: auto; height: 350px; background:#222; padding:10px; border-radius:5px; }
        /* ‡πÉ‡∏ä‡πâ .msg.chat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ä‡∏ó‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */
        .msg { text-align: left; margin:5px 0; padding:8px; border-radius:4px; background:#333; } 
        
        input, select, button { margin: 5px; padding: 8px; border-radius: 5px; border: none; }
        button { background:#0a84ff; color:white; cursor:pointer; }
    </style>
</head>
<body>
    <h2>üü£ TikTok Live Chat (‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ)</h2>

    <div>
        <input id="uniqueId" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ TikTok" />
        <button id="btn">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        <label>
            ‡πÄ‡∏™‡∏µ‡∏¢‡∏á:
            <select id="voiceSelect"></select>
        </label>
    </div>

    <div id="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    <div id="chat"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const voiceSelect = document.getElementById('voiceSelect');
    let voices = [];

    // ----------------------------------------------------
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢: ‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥/‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏≠‡∏≠‡∏Å
    // ----------------------------------------------------
    function filterEmoji(text) {
        // ‡πÉ‡∏ä‡πâ Regex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ö‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≠‡∏Å
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å Regex ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà
        const emojiRegex = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/g;
        
        // ‡∏•‡∏ö‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô
        let cleanText = text.replace(emojiRegex, '').trim();
        
        // ‡∏•‡∏ö‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏±‡∏Å‡∏©‡∏£/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏≤‡∏à‡∏≤‡∏Å Gift/Event ‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏∏‡∏î‡∏°‡∏≤
        cleanText = cleanText.replace(/[^a-zA-Z0-9\u0E00-\u0E7F\s\.\,\!\?]/g, '');

        return cleanText.replace(/\s\s+/g, ' ').trim(); // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
    }


    // ----------------------------------------------------
    // ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏û‡∏π‡∏î‡∏ã‡πâ‡∏≥)
    // ----------------------------------------------------
    let speakQueue = [];
    let isSpeaking = false;

    function processQueue() {
        if (speakQueue.length === 0) {
            isSpeaking = false;
            return;
        }
        
        if (isSpeaking) {
            speechSynthesis.cancel(); 
            isSpeaking = false;
        }

        const nextText = speakQueue.shift();
        isSpeaking = true;

        const utter = new SpeechSynthesisUtterance(nextText);
        const selectedName = voiceSelect.value;
        const selectedVoice = voices.find(v => v.name === selectedName);

        if (selectedVoice) {
            utter.voice = selectedVoice;
            utter.lang = selectedVoice.lang;
        } else {
            utter.lang = 'th-TH';
        }

        utter.rate = 0.6; 
        utter.pitch = 1;

        utter.onend = () => {
            isSpeaking = false;
            processQueue();
        };

        utter.onerror = (event) => {
            console.error('SpeechSynthesis Utterance Error:', event);
            isSpeaking = false;
            processQueue();
        };

        speechSynthesis.speak(utter);
    }

    function speak(text) {
        if (text.trim() === '') return;
        speakQueue.push(text);
        processQueue();
    }

    // ----------------------------------------------------
    // ‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    // ----------------------------------------------------
    
    function loadVoices() {
        voices = speechSynthesis.getVoices()
            .filter(v => v.lang.toLowerCase().includes('th'));
            
        voiceSelect.innerHTML = voices
            .map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`)
            .join('');

        const defaultVoice = voices.find(v => v.default) || voices[0];
        if (defaultVoice) voiceSelect.value = defaultVoice.name;
    }

    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;

    document.getElementById('btn').onclick = () => {
        speechSynthesis.cancel();
        speakQueue = [];
        isSpeaking = false;

        const uid = document.getElementById('uniqueId').value.trim();
        if (!uid) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ TikTok');
        document.getElementById('status').textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
        socket.emit('start', { uniqueId: uid });
    };

    socket.on('connected', data => {
        document.getElementById('status').textContent = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ roomId: ' + data.roomId;
    });

    // 1. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó (CHAT) - ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    socket.on('chat', data => {
        const rawComment = data.comment;
        
        // 1.1 ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó (‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏£‡∏ß‡∏°‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô)
        const div = document.createElement('div');
        div.className = 'msg'; // ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà .msg ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏•‡∏ö .gift/.like ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        div.textContent = `${data.nickname}: ${rawComment}`;
        const chatBox = document.getElementById('chat');
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;

        // 1.2 *** ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡∏Å‡πà‡∏≠‡∏ô ***
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ @ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (rawComment.trim().startsWith('@')) {
            console.log(`(Skipping mention: ${rawComment})`);
            return; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á
        }

        // 1.3 ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥/‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå)
        let speakText = filterEmoji(rawComment);

        // 1.4 ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥
        if (speakText.trim().length === 0) {
            console.log(`(Skipping emoji-only: ${rawComment})`);
            return; 
        }
        
        // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        speak(speakText);
    });
    
    // ‚ùå ‡∏•‡∏ö socket.on('gift', ...) ‡πÅ‡∏•‡∏∞ socket.on('like', ...) ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß

    socket.on('error', err => {
        document.getElementById('status').textContent = '‚ùå ' + err.msg;
    });
</script>
</body>
</html>
