<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TikTok Live Chat (with Voice)</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; text-align: center; }
    #chat { max-width:600px; margin:20px auto; overflow-y: auto; height: 350px; background:#222; padding:10px; border-radius:5px; }
    .msg { text-align: left; margin:5px 0; padding:8px; background:#333; border-radius:4px; }
    input, select, button { margin: 5px; padding: 8px; border-radius: 5px; border: none; }
    button { background:#0a84ff; color:white; cursor:pointer; }
  </style>
</head>
<body>
  <h2>🟣 TikTok Live Chat (พูดได้)</h2>

  <div>
    <input id="uniqueId" placeholder="ชื่อบัญชี TikTok" />
    <button id="btn">เชื่อมต่อ</button>
    <label>
      เสียง:
      <select id="voiceSelect"></select>
    </label>
  </div>

  <div id="status">ยังไม่ได้เชื่อมต่อ</div>
  <div id="chat"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const voiceSelect = document.getElementById('voiceSelect');
    let voices = [];

    // โหลดรายชื่อเสียงในเครื่อง (กรองเฉพาะภาษาไทยก่อน)
    function loadVoices() {
      voices = speechSynthesis.getVoices()
        .filter(v => v.lang.toLowerCase().includes('th')); // ✅ เฉพาะเสียงไทย
      voiceSelect.innerHTML = voices
        .map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`)
        .join('');

      // ตั้งเสียงเริ่มต้นอัตโนมัติ
      const defaultVoice = voices.find(v => v.default) || voices[0];
      if (defaultVoice) voiceSelect.value = defaultVoice.name;
    }
    speechSynthesis.onvoiceschanged = loadVoices;

    // เริ่มเชื่อมต่อ TikTok Live
    document.getElementById('btn').onclick = () => {
      const uid = document.getElementById('uniqueId').value.trim();
      if (!uid) return alert('กรุณากรอกชื่อบัญชี TikTok');
      document.getElementById('status').textContent = '⏳ กำลังเชื่อมต่อ...';
      socket.emit('start', { uniqueId: uid });
    };

    socket.on('connected', data => {
      document.getElementById('status').textContent = '✅ เชื่อมต่อ roomId: ' + data.roomId;
    });

    socket.on('chat', data => {
      const div = document.createElement('div');
      div.className = 'msg';
      div.textContent = `${data.nickname}: ${data.comment}`;
      const chatBox = document.getElementById('chat');
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;

      // อ่านออกเสียงภาษาไทย
      speak(`${data.comment}`);
    });

    socket.on('error', err => {
      document.getElementById('status').textContent = '❌ ' + err.msg;
    });

    // ฟังก์ชันอ่านออกเสียง
    function speak(text) {

       // หยุดเสียงที่ยังพูดอยู่ก่อน
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      
      const utter = new SpeechSynthesisUtterance(text);
      const selectedName = voiceSelect.value;
      utter.voice = voices.find(v => v.name === selectedName);
      utter.lang = utter.voice?.lang || 'th-TH';
      utter.rate = 0.8;
      utter.pitch = 1;
      speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
