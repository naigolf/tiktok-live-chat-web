<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>TikTok Live Chat (with Voice)</title>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; text-align: center; }
        #chat { max-width:600px; margin:20px auto; overflow-y: auto; height: 350px; background:#222; padding:10px; border-radius:5px; }
        .msg { text-align: left; margin:5px 0; padding:8px; border-radius:4px; }
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Event ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ä‡∏ó‡∏õ‡∏Å‡∏ï‡∏¥ */
        .msg.chat { background:#333; } 
        .msg.gift { background:#522812; color: #ffeb3b; } /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç */
        .msg.like { background:#1b3952; color: #4fc3f7; } /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏à */
        
        input, select, button { margin: 5px; padding: 8px; border-radius: 5px; border: none; }
        button { background:#0a84ff; color:white; cursor:pointer; }
    </style>
</head>
<body>
    <h2>üü£ TikTok Live Chat (‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ)</h2>

    <div>
        <input id="uniqueId" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ TikTok" />
        <button id="btn">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        <label>
            ‡πÄ‡∏™‡∏µ‡∏¢‡∏á:
            <select id="voiceSelect"></select>
        </label>
    </div>

    <div id="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    <div id="chat"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const voiceSelect = document.getElementById('voiceSelect');
    let voices = [];

    // ----------------------------------------------------
    // ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏û‡∏π‡∏î‡∏ã‡πâ‡∏≥)
    // ----------------------------------------------------
    let speakQueue = [];
    let isSpeaking = false;

    function processQueue() {
        if (speakQueue.length === 0) {
            isSpeaking = false;
            return;
        }
        
        if (isSpeaking) {
            speechSynthesis.cancel(); 
            isSpeaking = false;
        }

        const nextText = speakQueue.shift();
        isSpeaking = true;

        const utter = new SpeechSynthesisUtterance(nextText);
        const selectedName = voiceSelect.value;
        const selectedVoice = voices.find(v => v.name === selectedName);

        if (selectedVoice) {
            utter.voice = selectedVoice;
            utter.lang = selectedVoice.lang;
        } else {
            utter.lang = 'th-TH';
        }

        utter.rate = 0.8; 
        utter.pitch = 1;

        utter.onend = () => {
            isSpeaking = false;
            processQueue();
        };

        utter.onerror = (event) => {
            console.error('SpeechSynthesis Utterance Error:', event);
            isSpeaking = false;
            processQueue();
        };

        speechSynthesis.speak(utter);
    }

    function speak(text) {
        if (text.trim() === '') return;
        speakQueue.push(text);
        processQueue();
    }

    // ----------------------------------------------------
    // ‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    // ----------------------------------------------------
    
    function loadVoices() {
        voices = speechSynthesis.getVoices()
            .filter(v => v.lang.toLowerCase().includes('th'));
            
        voiceSelect.innerHTML = voices
            .map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`)
            .join('');

        const defaultVoice = voices.find(v => v.default) || voices[0];
        if (defaultVoice) voiceSelect.value = defaultVoice.name;
    }

    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;

    document.getElementById('btn').onclick = () => {
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
        speechSynthesis.cancel();
        speakQueue = [];
        isSpeaking = false;

        const uid = document.getElementById('uniqueId').value.trim();
        if (!uid) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ TikTok');
        document.getElementById('status').textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
        socket.emit('start', { uniqueId: uid });
    };

    socket.on('connected', data => {
        document.getElementById('status').textContent = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ roomId: ' + data.roomId;
    });

    // 1. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó (CHAT) - ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å speak()
    socket.on('chat', data => {
        const comment = data.comment;
        const div = document.createElement('div');
        div.className = 'msg chat';
        div.textContent = `${data.nickname}: ${comment}`;
        const chatBox = document.getElementById('chat');
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;

        // *** ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ @ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ***
        if (comment.trim().startsWith('@')) {
            console.log(`(Skipping mention: ${comment})`);
            return; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á
        }
        
        // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á
        speak(`${comment}`);
    });

    // 2. ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç (GIFT) - ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å speak()
    socket.on('gift', data => {
        const div = document.createElement('div');
        div.className = 'msg gift';
        div.textContent = data.message;
        const chatBox = document.getElementById('chat');
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // 3. ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡πÉ‡∏à (LIKE) - ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å speak()
    socket.on('like', data => {
        const div = document.createElement('div');
        div.className = 'msg like';
        div.textContent = data.message;
        const chatBox = document.getElementById('chat');
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
    
    socket.on('error', err => {
        document.getElementById('status').textContent = '‚ùå ' + err.msg;
    });
</script>
</body>
</html>
