<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>TikTok Live Chat (with Voice)</title>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; text-align: center; }
        #chat { max-width:600px; margin:20px auto; overflow-y: auto; height: 350px; background:#222; padding:10px; border-radius:5px; }
        .msg { text-align: left; margin:5px 0; padding:8px; background:#333; border-radius:4px; }
        input, select, button { margin: 5px; padding: 8px; border-radius: 5px; border: none; }
        button { background:#0a84ff; color:white; cursor:pointer; }
    </style>
</head>
<body>
    <h2>üü£ TikTok Live Chat (‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ)</h2>

    <div>
        <input id="uniqueId" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ TikTok" />
        <button id="btn">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        <label>
            ‡πÄ‡∏™‡∏µ‡∏¢‡∏á:
            <select id="voiceSelect"></select>
        </label>
    </div>

    <div id="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    <div id="chat"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const voiceSelect = document.getElementById('voiceSelect');
        let voices = [];

        // ----------------------------------------------------
        // ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏û‡∏π‡∏î‡∏ã‡πâ‡∏≥)
        // ----------------------------------------------------
        let speakQueue = [];
        let isSpeaking = false;

        function processQueue() {
            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏´‡∏¢‡∏∏‡∏î
            if (speakQueue.length === 0 || isSpeaking) {
                return;
            }

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß
            const nextText = speakQueue.shift();
            isSpeaking = true;

            const utter = new SpeechSynthesisUtterance(nextText);
            const selectedName = voiceSelect.value;
            const selectedVoice = voices.find(v => v.name === selectedName);

            if (selectedVoice) {
                utter.voice = selectedVoice;
                utter.lang = selectedVoice.lang;
            } else {
                // ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
                utter.lang = 'th-TH';
            }

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î (0.8 ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
            utter.rate = 0.8; 
            utter.pitch = 1;

            utter.onend = () => {
                isSpeaking = false;
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏à‡∏ö ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß
                processQueue();
            };

            utter.onerror = (event) => {
                console.error('SpeechSynthesis Utterance Error:', event);
                isSpeaking = false;
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏û‡∏π‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                processQueue();
            };

            // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î
            speechSynthesis.speak(utter);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß (‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å socket.on('chat'))
        function speak(text) {
            if (text.trim() === '') {
                return; 
            }
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß
            speakQueue.push(text);
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            processQueue();
        }

        // ----------------------------------------------------
        // ‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
        // ----------------------------------------------------
        function loadVoices() {
            voices = speechSynthesis.getVoices()
                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
                .filter(v => v.lang.toLowerCase().includes('th')); 
                
            voiceSelect.innerHTML = voices
                .map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`)
                .join('');

            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á Default ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏£‡∏Å)
            const defaultVoice = voices.find(v => v.default) || voices[0];
            if (defaultVoice) voiceSelect.value = defaultVoice.name;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        loadVoices(); 
        speechSynthesis.onvoiceschanged = loadVoices;


        // ----------------------------------------------------
        // ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ä‡∏ó
        // ----------------------------------------------------
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ TikTok Live
        document.getElementById('btn').onclick = () => {
            // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
            speechSynthesis.cancel(); 
            speakQueue = [];
            isSpeaking = false; 

            const uid = document.getElementById('uniqueId').value.trim();
            if (!uid) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ TikTok');
            document.getElementById('status').textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
            socket.emit('start', { uniqueId: uid });
        };

        socket.on('connected', data => {
            document.getElementById('status').textContent = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ roomId: ' + data.roomId;
        });

        socket.on('chat', data => {
            const div = document.createElement('div');
            div.className = 'msg';
            div.textContent = `${data.nickname}: ${data.comment}`;
            const chatBox = document.getElementById('chat');
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;

            // ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            speak(`${data.comment}`);
        });

        socket.on('error', err => {
            document.getElementById('status').textContent = '‚ùå ' + err.msg;
        });
    </script>
</body>
</html>
