<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TikTok Live Chat (with Voice)</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; text-align: center; }
    #chat { max-width:600px; margin:20px auto; overflow-y: auto; height: 350px; background:#222; padding:10px; border-radius:5px; }
    .msg { text-align: left; margin:5px 0; padding:8px; background:#333; border-radius:4px; }
    input, select, button { margin: 5px; padding: 8px; border-radius: 5px; border: none; }
    button { background:#0a84ff; color:white; cursor:pointer; }
  </style>
</head>
<body>
  <h2>ðŸŸ£ TikTok Live Chat (à¸žà¸¹à¸”à¹„à¸”à¹‰)</h2>

  <div>
    <input id="uniqueId" placeholder="à¸Šà¸·à¹ˆà¸­à¸šà¸±à¸à¸Šà¸µ TikTok" />
    <button id="btn">à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­</button>
    <label>
      à¹€à¸ªà¸µà¸¢à¸‡:
      <select id="voiceSelect"></select>
    </label>
  </div>

  <div id="status">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­</div>
  <div id="chat"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const voiceSelect = document.getElementById('voiceSelect');
    let voices = [];

    // à¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹€à¸ªà¸µà¸¢à¸‡à¹ƒà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ (à¸à¸£à¸­à¸‡à¹€à¸‰à¸žà¸²à¸°à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸à¹ˆà¸­à¸™)
    function loadVoices() {
      voices = speechSynthesis.getVoices()
        .filter(v => v.lang.toLowerCase().includes('th')); // âœ… à¹€à¸‰à¸žà¸²à¸°à¹€à¸ªà¸µà¸¢à¸‡à¹„à¸—à¸¢
      voiceSelect.innerHTML = voices
        .map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`)
        .join('');

      // à¸•à¸±à¹‰à¸‡à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
      const defaultVoice = voices.find(v => v.default) || voices[0];
      if (defaultVoice) voiceSelect.value = defaultVoice.name;
    }
    speechSynthesis.onvoiceschanged = loadVoices;

    // à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ TikTok Live
    document.getElementById('btn').onclick = () => {
      const uid = document.getElementById('uniqueId').value.trim();
      if (!uid) return alert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¸šà¸±à¸à¸Šà¸µ TikTok');
      document.getElementById('status').textContent = 'â³ à¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­...';
      socket.emit('start', { uniqueId: uid });
    };

    socket.on('connected', data => {
      document.getElementById('status').textContent = 'âœ… à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ roomId: ' + data.roomId;
    });

    socket.on('chat', data => {
      const div = document.createElement('div');
      div.className = 'msg';
      div.textContent = `${data.nickname}: ${data.comment}`;
      const chatBox = document.getElementById('chat');
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;

      // à¸­à¹ˆà¸²à¸™à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡à¸ à¸²à¸©à¸²à¹„à¸—à¸¢
      speak(`${data.comment}`);
    });

    socket.on('error', err => {
      document.getElementById('status').textContent = 'âŒ ' + err.msg;
    });

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸­à¹ˆà¸²à¸™à¸­à¸­à¸à¹€à¸ªà¸µà¸¢à¸‡
    function speak(text) {

       // à¸«à¸¢à¸¸à¸”à¹€à¸ªà¸µà¸¢à¸‡à¸—à¸µà¹ˆà¸¢à¸±à¸‡à¸žà¸¹à¸”à¸­à¸¢à¸¹à¹ˆà¸à¹ˆà¸­à¸™
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      
      const utter = new SpeechSynthesisUtterance(text);
      const selectedName = voiceSelect.value;
      utter.voice = voices.find(v => v.name === selectedName);
      utter.lang = utter.voice?.lang || 'th-TH';
      utter.rate = 0.8;
      utter.pitch = 1;
      speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
