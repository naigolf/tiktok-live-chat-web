<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>TikTok Live Chat (with Voice)</title>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; text-align: center; }
        #chat { max-width:600px; margin:20px auto; overflow-y: auto; height: 350px; background:#222; padding:10px; border-radius:5px; }
        .msg { text-align: left; margin:5px 0; padding:8px; border-radius:4px; background:#333; } 
        
        input, select, button { margin: 5px; padding: 8px; border-radius: 5px; border: none; }
        button { background:#0a84ff; color:white; cursor:pointer; }
    </style>
</head>
<body>
    <h2>üü£ TikTok Live Chat (‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ)</h2>

    <div>
        <input id="uniqueId" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ TikTok" />
        <button id="btn">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        <label>
            ‡πÄ‡∏™‡∏µ‡∏¢‡∏á:
            <select id="voiceSelect"></select>
        </label>
    </div>

    <div id="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    <div id="chat"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const voiceSelect = document.getElementById('voiceSelect');
    let voices = [];

    // ----------------------------------------------------
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢: ‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥/‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏≠‡∏≠‡∏Å
    // ----------------------------------------------------
    function filterEmoji(text) {
        const emojiRegex = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/g;
        let cleanText = text.replace(emojiRegex, '').trim();
        cleanText = cleanText.replace(/[^a-zA-Z0-9\u0E00-\u0E7F\s\.\,\!\?]/g, '');
        return cleanText.replace(/\s\s+/g, ' ').trim();
    }


    // ----------------------------------------------------
    // ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö)
    // ----------------------------------------------------
    let speakQueue = [];
    let isSpeaking = false;

    function processQueue() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
        if (speakQueue.length === 0 || isSpeaking) {
            isSpeaking = (speakQueue.length === 0) ? false : isSpeaking;
            return;
        }
        
        // ‚ùå ‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î speechSynthesis.cancel() ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏û‡∏π‡∏î‡∏à‡∏ô‡∏à‡∏ö

        const nextText = speakQueue.shift();
        isSpeaking = true;

        const utter = new SpeechSynthesisUtterance(nextText);
        const selectedName = voiceSelect.value;
        const selectedVoice = voices.find(v => v.name === selectedName);

        if (selectedVoice) {
            utter.voice = selectedVoice;
            utter.lang = selectedVoice.lang;
        } else {
            utter.lang = 'th-TH';
        }

        utter.rate = 0.7; 
        utter.pitch = 1;

        utter.onend = () => {
            isSpeaking = false;
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏à‡∏ö ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß
            processQueue();
        };

        utter.onerror = (event) => {
            console.error('SpeechSynthesis Utterance Error:', event);
            isSpeaking = false;
            processQueue();
        };

        speechSynthesis.speak(utter);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß
    function speak(text) {
        if (text.trim() === '') return;
        speakQueue.push(text);
        
        // ‚úÖ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å processQueue() ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô 
        // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î‡∏≠‡∏¢‡∏π‡πà ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å utter.onend
        if (!isSpeaking) {
            processQueue();
        }
    }

    // ----------------------------------------------------
    // ‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    // ----------------------------------------------------
    
    function loadVoices() {
        voices = speechSynthesis.getVoices()
            .filter(v => v.lang.toLowerCase().includes('th'));
            
        voiceSelect.innerHTML = voices
            .map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`)
            .join('');

        const defaultVoice = voices.find(v => v.default) || voices[0];
        if (defaultVoice) voiceSelect.value = defaultVoice.name;
    }

    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;

    document.getElementById('btn').onclick = () => {
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        speechSynthesis.cancel();
        speakQueue = [];
        isSpeaking = false;

        const uid = document.getElementById('uniqueId').value.trim();
        if (!uid) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ TikTok');
        document.getElementById('status').textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
        socket.emit('start', { uniqueId: uid });
    };

    socket.on('connected', data => {
        document.getElementById('status').textContent = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ roomId: ' + data.roomId;
    });

    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó (CHAT) - ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    socket.on('chat', data => {
        const rawComment = data.comment;
        
        // 1. ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
        const div = document.createElement('div');
        div.className = 'msg';
        div.textContent = `${data.nickname}: ${rawComment}`;
        const chatBox = document.getElementById('chat');
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;

        // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á (Mention) 
        if (rawComment.trim().startsWith('@')) {
            return; 
        }

        // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥/‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå)
        let speakText = filterEmoji(rawComment);

        // 4. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥
        if (speakText.trim().length === 0) {
            return; 
        }
        
        // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
        speak(speakText);
    });

    socket.on('error', err => {
        document.getElementById('status').textContent = '‚ùå ' + err.msg;
    });
</script>
</body>
</html>
